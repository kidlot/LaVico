<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script>
        function fileSelected(pic) {
            document.getElementById('progressNumber').innerHTML = "";
            var file = document.getElementById('pic').files[0];
            if (file) {
                var fileSize = 0;
                if (file.size > 1024 * 1024)
                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
                else
                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
                uploadFile(pic);
            }
        }

        function uploadFile(pic) {
            var fd = new FormData();
            fd.append("pic",pic.files[0]);
            //fd.append("pic", document.getElementById('pic').files[0]);
            var xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", uploadProgress, false);
            xhr.addEventListener("load", uploadComplete, false);
            xhr.addEventListener("error", uploadFailed, false);
            xhr.addEventListener("abort", uploadCanceled, false);
            xhr.open("POST", "/welab/Uploadify?$layout=false&$render=false");
            xhr.send(fd);
        }

        function uploadProgress(evt) {
            if (evt.lengthComputable) {
                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
            }
            else {
                document.getElementById('progressNumber').innerHTML = 'unable to compute';
            }
        }

        function uploadComplete(evt) {
            var json = eval('(' + evt.target.responseText + ')');

            //$(".img-polaroid").attr("src",json.model.fileName);
            $(".picView").css("display","");
            $(".picView").find("img").attr("src",json.model.fileName);
            setVal( nowLineNum, {pic:json.model.fileName});

            $("#pic").val("")

            $(".rightRow").height( (parseInt($(".settingView").height()) + parseInt($(".settingView").position().top)) +30);
        }

        function uploadFailed(evt) {
            alert("There was an error attempting to upload the file.");
        }

        function uploadCanceled(evt) {
            alert("The upload has been canceled by the user or the browser dropped the connection.");
        }

        function delPic ( then){

            var oLinkOptions = {} ;
            oLinkOptions.data = [];
            oLinkOptions.data.push({name:"pic",value:$(then).parent().prev().attr("src")});
            oLinkOptions.type = "POST";
            oLinkOptions.url = "/welab/Uploadify:delpic";

            $.request(oLinkOptions,function(err,nut){
                if(err) throw err ;

                $(".picView").hide();
                nut.msgqueue.popup() ;

                $("#progressNumber").hide();

                setVal(nowLineNum,{pic:""});

                if( nowLineNum == 0){
                    $(".firstItem").find("img").attr("src", firstPic)
                }else{
                    var _opt =  $(".list").children("div").eq(nowLineNum-1);
                    _opt.find("img").attr("src", otherPic)
                }
                $("#pic").val("")
            }) ;
        }

    </script>
</head>
<body>
<span id="progressNumber"></span>
<input type="file"  name="pic" placeholder="请输入...." id="pic" onchange="fileSelected(this);">
&nbsp;<span id="progressNumber"></span>
<div class="alert alert-success picView file_box" style="display: none">
    <img class="media-object" style="width: 64px; height: 64px;" src="/node_modules/welab/public/defaultPic.png">
    <span><a href="javascript:;" onclick="delPic(this)">删除</a></span>
</div>
</body>
</html>