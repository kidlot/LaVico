<ul class="breadcrumb clearfix">
    <li class="b01"><a href="/welab/AppList" class="stay">应用</a> <em></em></li>
</ul>

<div class="panel panel-default formText" >
    <div class="panel-heading clearfix">
        <a class="btn btn-defalut btn-social-googleplus pull-left" href="/lavico/activity"><i class="fui-arrow-left"></i> 返回</a>
        <a class="btn btn-success btn-social-googleplus pull-right" href="javascript:;" onclick="save()" ><i class="glyphicon glyphicon-circle-arrow-down"></i> 保存</a>
    </div>    
    <div class="panel-body" style="background:#f9fafb;">
       <div class="col-md-12">
            <div class="settingView">
                <div class="form-arrow"></div>
                <form class="form-horizontal" role="form">     
                    <h6>原始信息</h6>
                    <br>
                    <div class="form-group">
                        <label for="inputEmail3" class="col-sm-2">名称</label>
                        <div class="col-sm-10">
                            <span>{@activity.PROMOTION_NAME}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputEmail3" class="col-sm-2">描述</label>
                        <div class="col-sm-10">
                            <span>{@activity.PROMOTION_DESC}</span>
                        </div>
                    </div>                                        

                    <br>
                    <h6>附加信息</h6>
                    <br>                    
                    
                      <div class="panel panel-default formText pagePanel">
                          <div class="panel-body">
                              <div class="col-md-9">
                                  <div class="form-group">
                                      <label for="inputEmail3" class="col-sm-2 control-label">面值</label>
                                      <div class="col-sm-10" style="padding-top: 8px;">
                                          <span>{@activity.QTY}</span>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <label for="inputEmail3" class="col-sm-2 control-label">券图<span>(400×400)</span></label>
                                      <div class="col-sm-10" style="padding-top: 8px;">
                                        <input type="file" class="input-xlarge"  style="width:206px" data="{@activity.QTY}" name="{@activity.QTY}" placeholder="请输入...." id="{@activity.QTY}" onchange="fileSelected(this.id);">
                                        &nbsp;<span calss="progressNumber"></span>

                                        <div class="alert alert-success picView file_box">
                                            <img id='{@activity.QTY}_image' class="media-object image_data" data="{@activity.QTY}" style="height: 64px;" src="{@activity.pic}">
                                        </div>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <label for="inputEmail3" class="col-sm-2 control-label">详细介绍</label>
                                      <div class="col-sm-10" style="padding-top: 8px;">
                                          <textarea class="form-control input-sm postData" rows="3" data="{@activity.QTY}" id="{@activity.QTY}_introduction" name="introduction" promotion_name="{@activity.PROMOTION_NAME}"  promotion_desc="{@activity.PROMOTION_DESC}"  placeholder="请输入..." style="height:400px;">{@activity.introduction}</textarea>
                                      </div>
                                  </div>                           
                              </div>
                          </div>
                      </div>

                    <input type=hidden name='aid' id='aid' value='{@activity.PROMOTION_CODE}' />
                </form>
            </div>
        </div>        
    </div>
</div>
<script src="/welab/public/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<link href="/welab/public/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<script src="/welab/public/ckeditor/ckeditor.js"></script>


<script>
        var aItemList = {};
        var flag = 0;
        var _inputCheck = true;
        var content;
        var editor;



        function save( ){

            var _content = editor.document.getBody().getHtml();

            var _inputCheck = true;
            $(".postData").each(function(i,o){
                if(!_content){
                    _inputCheck = false;
//                    $.globalMessenger().post({
//                        message: "详细介绍不能为空！",
//                        type: 'error',
//                        showCloseButton: true})
                }else{
                  if(!aItemList[$(o).attr("data")]){
                    aItemList[$(o).attr("data")] = {};
                  }
                  var content = editor.document.getBody().getHtml();
                  aItemList[$(o).attr("data")].introduction = encodeURIComponent(content);
                  aItemList[$(o).attr("data")].promotion_name = $(o).attr("promotion_name");
                  aItemList[$(o).attr("data")].promotion_desc = $(o).attr("promotion_desc");
                }
            })

            $(".image_data").each(function(i,o){
              if($(o).attr('src')){
                if(!aItemList[$(o).attr("data")]){
                  aItemList[$(o).attr("data")] = {};
                }
                aItemList[$(o).attr("data")].pic = $(o).attr("src");
              }
            });


            if(_inputCheck){
                var oLinkOptions = {} ;
                oLinkOptions.data = [{name:'postData',value:JSON.stringify(aItemList)},{name:'aid',value:$("#aid").val()}];
                oLinkOptions.type = "POST";
                oLinkOptions.url = "/lavico/activity/index:save";
                flag = 1;
                $.request(oLinkOptions,function(err,nut){
                    if(err) throw err ;
                    flag = 0;
                    nut.msgqueue.popup() ;
                    //$.controller("/lavico/activity",null,"lazy");
                }) ;
            }

        }


        content = decodeURIComponent('{@activity.introduction}');

        /*编辑器*/
        editor = CKEDITOR.replace( 'introduction', {
            toolbar: [
                ['Source','-','Save','NewPage','Preview','-','Templates'],
                ['Undo', 'Redo', '-', 'SelectAll', 'RemoveFormat'],
                ['Styles','Format','Font','FontSize'],
                ['TextColor','BGColor'],
                ['Maximize', 'ShowBlocks'],
                '/',
                ['Bold','Italic','Underline','Strike','-','Subscript','Superscript'],
                ['NumberedList','BulletedList','-','Outdent','Indent','Blockquote','CreateDiv'],
                ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'],
                ['Link','Unlink','Anchor'],
                ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak'],
                ['Code']
            ]
        });
        if(content){
            editor.setData(content);
        }

      
      var lastPic = ""
      function fileSelected(inputid) {

          $("#"+inputid).next(".progressNumber").text("")
          var file = document.getElementById(inputid).files[0];
          if (file) {

              var fileSize = 0;
              if (file.size > 1024 * 1024)
                  fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
              else
                  fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

              lastPic = inputid

              uploadFile();

          }
      }

      function uploadFile() {
          var fd = new FormData();
          fd.append(lastPic, document.getElementById(lastPic).files[0]);
          var xhr = new XMLHttpRequest();
          xhr.upload.addEventListener("progress", uploadProgress, false);
          xhr.addEventListener("load", uploadComplete, false);
          xhr.addEventListener("error", uploadFailed, false);
          xhr.addEventListener("abort", uploadCanceled, false);
          xhr.open("POST", "/welab/Uploadify?$layout=false&$render=false");
          xhr.send(fd);

      }

      function uploadProgress(evt) {
          if (evt.lengthComputable) {
              var percentComplete = Math.round(evt.loaded * 100 / evt.total);

              $("#"+lastPic).next(".progressNumber").text(percentComplete.toString() + '%')
          }
          else {
              $("#"+lastPic).next(".progressNumber").text('unable to compute')
          }
      }

      function uploadComplete(evt) {
          var json = eval('(' + evt.target.responseText + ')');
          var filename = json.model.fileName;
          $("#"+lastPic+"_image").attr("src",filename)
      }

      function uploadFailed(evt) {
          alert("上传失败");
      }

      function uploadCanceled(evt) {
          alert("已经取消上传");
      }
</script>     
