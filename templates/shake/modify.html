<style>
    label {
        display: inline-block;
        margin-bottom: 5px;
        font-weight: bold;
    }
</style>
<ul class="breadcrumb clearfix">
    <li class="b01"><a href="/welab/AppList" class="stay">应用</a> <em></em></li>
    <li class="b02"><a href="/welab/AppList" class="stay">应用管理</a> <em></em></li>
    <li class="b03"><a href="/lavico/shake" >摇一摇</a></li>
    <li class="b03"><a href="#" class="stay">编辑</a></li>
    <li class="pull-right"><a href="/lavico/shake"><i class="fui-arrow-left"></i>返回</a></li>
</ul>

<div class="panel panel-default formText" >
    <div class="panel-heading clearfix">
        <a class="btn btn-defalut btn-social-googleplus pull-left" href="/lavico/shake"><i class="fui-arrow-left"></i> 返回</a>
        <a class="btn btn-success btn-social-googleplus pull-right save" href="javascript:;" onclick="save();"><i class="fui-check-inverted"></i> 保存</a>
    </div>
    <div class="panel-body" style="background:#f9fafb;">
        <div class="col-md-12">


            <form class="form-horizontal" role="form">
                <h6>基础设置</h6>
                <br>
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">图文URL</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="host-url" readonly value="http://{@host}/lavico/activity/shake?uid={wxid}&aid={@shake._id}" style="width: 300px;color: #9B9B9B;float: left">
                        <button type="button" id="btnCopy" name="btnCopy" class="btn btn-primary" style="float: left;margin-left: 6px" >复制</button>
                    </div>
                </div>


                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">开始/结束</label>
                    <div class="col-sm-10">
                        <input type="text" id="startDate" name="startDate" class="form-control" style="width: 150px;display:inline-block;" value="{@ shake.startDate && new Date(parseInt(shake.startDate)+28800000).toISOString().substr(0,10)}">
                        <input type="text" id="endDate" name="endDate" class="form-control" style="width: 150px;display:inline-block;" value="{@ shake.endDate && new Date(parseInt(shake.endDate)+28800000).toISOString().substr(0,10)}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">名称</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control postData" id='name' name="name" placeholder="名称" style="width: 300px;" value="{@ shake.name}" oninput="$('#pagename').text(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="points" class="col-sm-2">积分消耗/每次</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control postData" id='points' name="points" placeholder="0" style="width: 300px;" value="{@ shake.points}" oninput="$('#pagename').text(this.value)">
                    </div>
                </div>

                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">抽奖频率</label>
                    <div class="col-sm-10">
                        <select class="form-control" id='lottery_cycle' style="width: 150px;display:inline-block;" name="type">
                            <option value="1">1天</option>
                            <option value="2">1周</option>
                            <option value="3">1月</option>
                            <option value="100">永久</option>
                        </select>
                        <input type="text" id='lottery_count' class="form-control" name="name" placeholder="抽奖次数" style="width: 300px;display:inline-block;" value="{@ shake.lottery_count}" oninput="$('#pagename').text(this.value)">
                    </div>

                </div>

                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">详细介绍</label>
                    <div class="col-sm-10">
                        <textarea type="text" class="form-control postData" id='content' name="content" style="width: 80%;height:300px;" oninput="$('#pagename').text(this.value)">{@shake.content}</textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2">券</label>
                    <div class="col-sm-10">
                        <select class="form-control" style="width: 150px;display:inline;" id='activity_select' name="type">
                            <option value="0">请选择优惠券</option>
                            <foreach for="@list" var="doc">
                                <option value="{@doc.PROMOTION_CODE}">{@doc.PROMOTION_NAME}</option>
                            </foreach>
                        </select>
                        <button type="button" id="add-coupons" name="add-coupons" class="btn btn-primary" style="margin-left: 0" >添加</button>
                        <button type="button" id="del-coupons" name="del-coupons" class="btn btn-primary" style="margin-left: 0" >删除</button>
                    </div>
                </div>

                <br>
                <h6>内容</h6>
                <br>
                <div id="promotions">
                    <foreach for="@list" var="doc">
                        <div id='{@doc.PROMOTION_CODE}' class="promotion_detail" style="display:none;">

                            <div class="panel panel-default formText pagePanel">
                                <div class="panel-body">
                                    <div class="col-md-9">
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券号</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_CODE" data="{@doc.PROMOTION_CODE}">{@doc.PROMOTION_CODE}</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券名</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_NAME" data="{@doc.PROMOTION_NAME}">{@doc.PROMOTION_NAME}</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券描述</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_DESC" data="{@doc.PROMOTION_DESC}">{@doc.PROMOTION_DESC}</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券类型</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_TYPE" data="{@doc.TYPE}">{@doc.TYPE}</span>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">面值</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_QTY" data="{@doc.QTY}">{@doc.QTY}</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券图</label>
                                            <div class="col-sm-10">
                                                <if condition="@doc.pic">
                                                    <img class="PROMOTION_PIC" data="{@doc.pic}" src="{@doc.pic}" style="max-width:60%; "/>
                                                    <else/>
                                                    空(请到应用管理中的“活动券”设置)
                                                </if>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">已发放/总数</label>
                                            <div class="col-sm-10">
                                                <span class="PROMOTION_USED_TOTAL" data="{@ doc.USED}/{@doc.TOTAL}">{@ doc.USED}/{@doc.TOTAL}</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">券名称（用户获取时的名称）</label>
                                            <div class="col-sm-10">
                                                <input type="text" class="form-control display_name" name="display_name" placeholder="券名称" style="width: 300px;" value="{@ doc.display_name}" oninput="$('#pagename').text(this.value)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="inputEmail3" class="col-sm-2">抽奖概率</label>
                                            <div class="col-sm-10">
                                                <input type="text" value='' class="form-control postData lottery_chance" style="width:150px;display:inline-block"/>%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </foreach>
                </div>

                <input type='hidden' id='lottery_input' value='{@shake.lottery_cycle}' />
                <input type='hidden' id='_id' value='{@shake._id}' />
                <input type='hidden' id='lottery_chance' value='{@ shake.lottery && shake.lottery[0] && shake.lottery[0].lottery_chance}' />
            </form>
        </div>
    </div>
</div>

<script src="/welab/public/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<link href="/welab/public/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<script src="/welab/public/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="/opencomb/public/lib/3party/jquery-1.9.1.min.js"></script>

<script>
/*点击复制按钮*/
var init = function (){
    $('#btnCopy').click(function(){
        copyToClipboard($(this).val());
    });
    var _lottery = {@lottery};
    console.log(_lottery);
    for(var _i=0;_i<_lottery.length;_i++){
        var _PROMOTION_CODE = _lottery[_i].PROMOTION_CODE;
        var _display_name = _lottery[_i].display_name;
        var _lottery_chance = _lottery[_i].lottery_chance;
        $('#'+_PROMOTION_CODE).show();
        $('#'+_PROMOTION_CODE).find('.display_name').val(_display_name);
        $('#'+_PROMOTION_CODE).find('.lottery_chance').val(_lottery_chance);

    }
}
init();
/*编辑器*/
//var content = decodeURIComponent('{@shake.content}');
//
//console.log(content);
///*编辑器*/
//editor = CKEDITOR.replace( 'content', {
//    toolbar: [
//        ['Source','-','Save','NewPage','Preview','-','Templates'],
//        ['Undo', 'Redo', '-', 'SelectAll', 'RemoveFormat'],
//        ['Styles','Format','Font','FontSize'],
//        ['TextColor','BGColor'],
//        ['Maximize', 'ShowBlocks'],
//        '/',
//        ['Bold','Italic','Underline','Strike','-','Subscript','Superscript'],
//        ['NumberedList','BulletedList','-','Outdent','Indent','Blockquote','CreateDiv'],
//        ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'],
//        ['Link','Unlink','Anchor'],
//        ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak'],
//        ['Code']
//    ]
//});
//if(content){
//    editor.setData(content);
//}

function save(){

    var aFormInput = {}

    var _inputCheck = true;

    /*日期判断*/
    var _startDate = $('#startDate').val();
    var startDate = new Date();
    var startDateTimeStamp;
    startDate.setFullYear(_startDate.substring(0,4));
    startDate.setMonth((parseInt(_startDate.substr(5,2))-1));
    startDate.setDate((parseInt(_startDate.substr(8,2))));
    startDate.setHours(0,0,0);
    startDateTimeStamp = Date.parse(startDate);//毫秒级

    var _endDate =$('#endDate').val();
    var endDate = new Date();
    var endDateTimeStamp;
    endDate.setFullYear(_endDate.substring(0,4));
    endDate.setMonth((parseInt(_endDate.substr(5,2))-1));
    endDate.setDate((parseInt(_endDate.substr(8,2))));
    endDate.setHours(0,0,0);
    endDateTimeStamp = Date.parse(endDate);//毫秒级


    var aid = $('#aid').val();
    if(startDateTimeStamp > endDateTimeStamp){
        _inputCheck = false;
        $.globalMessenger().post({
            message: "开始时间必须比结束时间早！",
            type: 'error',
            showCloseButton: true})
    }



    if(!$("#startDate").val()){
      _inputCheck = false;
      $.globalMessenger().post({
          message: "请选择开始时间！",
          type: 'error',
          showCloseButton: true})
      
    }
    if(!$("#endDate").val()){
      _inputCheck = false;
      $.globalMessenger().post({
          message: "请选择结束时间！",
          type: 'error',
          showCloseButton: true})
      
    }
    
    if(!$("#name").val()){
      _inputCheck = false;
      $.globalMessenger().post({
          message: "请填写名称！",
          type: 'error',
          showCloseButton: true})      
    }

    
    if(!$('#lottery_cycle').val()){
      _inputCheck = false;
      $.globalMessenger().post({
          message: "请选择抽奖频率！",
          type: 'error',
          showCloseButton: true})       
    }
    if(!$('#lottery_count').val()){

      _inputCheck = false;
      $.globalMessenger().post({
          message: "请填写抽奖次数！",
          type: 'error',
          showCloseButton: true})       
    }

    var reg = /^\d+$/;//数字正则

    if(!$.isNumeric($('#lottery_count').val())){

        _inputCheck = false;
        $.globalMessenger().post({
            message: "抽奖次数的值必须是数字！",
            type: 'error',
            showCloseButton: true});
    }else{

        if(parseInt($('#lottery_count').val()) <= 0){
            _inputCheck = false;
            $.globalMessenger().post({
                message: "抽奖次数的值必须是正整数！",
                type: 'error',
                showCloseButton: true});
        }else{
            if(parseInt($('#lottery_count').val()) != $('#lottery_count').val()){

                _inputCheck = false;
                $.globalMessenger().post({
                    message: "抽奖次数的值必须是整数！",
                    type: 'error',
                    showCloseButton: true});

            }
        }
    }

    if(!$.isNumeric($('#points').val())){

        _inputCheck = false;
        $.globalMessenger().post({
            message: "积分消耗的值必须是数字！",
            type: 'error',
            showCloseButton: true});
    }else{

        if(parseInt($('#points').val()) < 0){
            _inputCheck = false;
            $.globalMessenger().post({
                message: "积分消耗的值必须是零或者正整数！",
                type: 'error',
                showCloseButton: true});
        }else{
            if(parseInt($('#points').val()) != $('#points').val()){

                _inputCheck = false;
                $.globalMessenger().post({
                    message: "积分消耗的值必须是整数！",
                    type: 'error',
                    showCloseButton: true});

            }
        }
    }


    if(!_inputCheck){
      return false;
    }
    
    aFormInput['lottery'] = new Array();
    $(".promotion_detail").each(function(i,object){
        console.log($(object).is(':visible'));
        if($(object).is(':visible')){
            if(!$(object).find('.lottery_chance').val()){
                var _PROMOTION_NAME = $(object).find('.PROMOTION_NAME').attr('data');
                _inputCheck = false;
                $.globalMessenger().post({
                    message: _PROMOTION_NAME + "的抽奖概率不能为空！",
                    type: 'error',
                    showCloseButton: true})
            }else{
                var _lottery = {};
                _lottery.PROMOTION_CODE = $(object).find('.PROMOTION_CODE').attr('data');
                _lottery.PROMOTION_NAME = $(object).find('.PROMOTION_NAME').attr('data');
                _lottery.PROMOTION_DESC = $(object).find('.PROMOTION_DESC').attr('data');
                _lottery.PROMOTION_TYPE = $(object).find('.PROMOTION_TYPE').attr('data');
                _lottery.PROMOTION_QTY = $(object).find('.PROMOTION_QTY').attr('data') || null;
                _lottery.PROMOTION_PIC = $(object).find('.PROMOTION_PIC').attr('data') || null;
                _lottery.PROMOTION_USED_TOTAL = $(object).find('.PROMOTION_USED_TOTAL').attr('data');
                _lottery.display_name = $(object).find('.display_name').val();
                _lottery.lottery_chance = $(object).find('.lottery_chance').val();
                aFormInput['lottery'].push(_lottery);
            }
        }
    })

    //var content = editor.document.getBody().getHtml();
    var content = $('#content').val();
    aFormInput['startDate'] = new Date($("#startDate").val()).getTime();
    aFormInput['endDate'] = new Date($("#endDate").val()).getTime();
    aFormInput['name'] = $("#name").val();
    aFormInput['lottery_cycle'] = $("#lottery_cycle").val();
    aFormInput['lottery_count'] = $("#lottery_count").val();
    aFormInput['switcher'] = 'on';
    aFormInput['createTime'] = new Date().getTime();
    aFormInput['points'] = parseInt($("#points").val()) || 0;//每次游戏，所消耗的积分
    aFormInput['content'] = content;
    aFormInput['display_name'] = $("#display_name").val();//券名称
    console.log(aFormInput)


    if(_inputCheck){
        var oLinkOptions = {} ;
        oLinkOptions.data = [{name:'postData',value:JSON.stringify(aFormInput)},{name:'_id',value:$("#_id").val()}];
        oLinkOptions.type = "POST";
        oLinkOptions.url = "/lavico/shake/index:save";

        $.request(oLinkOptions,function(err,nut){
            if(err) throw err ;
            nut.msgqueue.popup();
            //$.controller("/lavico/shake",null,"lazy");
        }) ;
    }
}



function copyToClipboard(txt) {

    if (window.clipboardData) {
        window.clipboardData.clearData();
        window.clipboardData.setData("Text", txt);
        alert("复制成功！")
    } else if (navigator.userAgent.indexOf("Opera") != -1) {
        window.location = txt;
        alert("复制成功！");
    } else if (window.netscape) {
        try {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
        } catch (e) {
            alert("被浏览器拒绝！\n请在浏览器地址栏输入'about:config'并回车\n然后将 'signed.applets.codebase_principal_support'设置为'true'");
        }
        var clip = Components.classes['@mozilla.org/widget/clipboard;1'].createInstance(Components.interfaces.nsIClipboard);
        if (!clip)
            return;
        var trans = Components.classes['@mozilla.org/widget/transferable;1'].createInstance(Components.interfaces.nsITransferable);
        if (!trans)
            return;
        trans.addDataFlavor('text/unicode');
        var str = new Object();
        var str = Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);
        var copytext = txt;
        str.data = copytext;
        trans.setTransferData("text/unicode", str, copytext.length * 2);
        var clipid = Components.interfaces.nsIClipboard;
        if (!clip)
            return false;
        clip.setData(trans, null, clipid.kGlobalClipboard);
        alert("复制成功！")
    }else if(typeof(copy) == "function"){
        copy(txt);
        alert("复制成功！")
    }else{
        alert("浏览器不支持,请手动复制。"+txt)
    }
}

</script>

